apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: envoy-gateway
  namespace: flux-system
spec:
    values: 
        config:
          envoyGateway:
            gateway:
              controllerName: gateway.envoyproxy.io/gatewayclass-controller
            logging:
              level:
                default: info
            provider:
              type: Kubernetes
              kubernetes:
                rateLimitDeployment:
                  patch:
                    type: StrategicMerge
                    value:
                      spec:
                        template:
                          spec:
                            containers:
                              - name: envoy-ratelimit
                                imagePullPolicy: IfNotPresent
                                image: docker.io/envoyproxy/ratelimit:60d8e81b
            rateLimit:
                  backend:
                    type: Redis
                    redis:
                      # Update this URL to match your Redis service location
                      # This assumes Redis is deployed using the redis.yaml in this directory
                      url: redis.redis-system.svc.cluster.local:6379                    
            extensionApis:
              # Not strictly required, but recommended for backward/future compatibility.
              enableEnvoyPatchPolicy: true
              # Required: Enable Backend API for AI service backends.
              enableBackend: true
            # Required: AI Gateway needs to fine-tune xDS resources generated by Envoy Gateway.
            extensionManager:
              hooks:
                xdsTranslator:
                  translation:
                    listener:
                      includeAll: true
                    route:
                      includeAll: true
                    cluster:
                      includeAll: true
                    secret:
                      includeAll: true
                  post:
                    - Translation
                    - Cluster
                    - Route
                    # Enable InferencePool custom resource support
              backendResources:
                - group: inference.networking.k8s.io
                  kind: InferencePool
                  version: v1
              service:
                fqdn:
                  # IMPORTANT: Update this to match your AI Gateway controller service
                  # Format: <service-name>.<namespace>.svc.cluster.local
                  # Default if you followed the installation steps above:
                  hostname: ai-gateway-controller.envoy-ai-gateway-system.svc.cluster.local
                  port: 1063
